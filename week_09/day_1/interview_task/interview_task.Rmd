---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(janitor)
library(infer)
```

```{r}
scotland_level <- read_csv("data/opendata_inc9519_scotland.csv")
by_region <- read_csv("data/opendata_inc9519_region.csv")
by_health_board <- read_csv("data/opendata_inc9519_hb.csv")
label_data <- read_csv("data/geography_codes_and_labels_hb2014_01042019.csv")

by_health_board <- clean_names(by_health_board)

```


In order to help inform the planning for provision of cancer treatment services in NHS Borders, we would like to gain better understanding of the incidence of cancer in NHS Borders.

To begin to answer / explore this 
 - I assumed that the data was new, i.e. that this would only include new diagnoses / 
 stats from this year
 - This data goes back to 1995 

## Question 1 - What are the 5 most common / prevalent types ?

```{r}
by_health_board %>%
  select(1:7) %>%
  filter(hb == "S08000016", cancer_site != "All cancer types") %>%
  group_by(cancer_site) %>%
  summarise(sum_type = sum(incidences_all_ages)) %>%
  arrange(desc(sum_type)) %>%
  head(5) %>%
  ggplot(aes(x = cancer_site, y = sum_type)) +
  geom_col() +
  coord_flip()

```
Because there are a large amount of types, to present the information in a reasonable limit, it was necessary to set a limit, so this was set at 5.
These numbers are calculated across 1995-2019, to gain a basic insight into whether there is a prevalent type, and if so, which. 


## Question 2 - How does this break down across time?

```{r}
by_health_board %>%
  select(1:7) %>%
  filter(hb == "S08000016", cancer_site != "All cancer types",
         cancer_site == "Breast" | 
         cancer_site == "Trachea, bronchus and lung" |
          cancer_site == "Non-melanoma skin cancer" |
          cancer_site == "Colorectal cancer" | 
          cancer_site == "Basal cell carcinoma of the skin",
         sex == "All"
         ) %>%
  ggplot(aes(x = year, y = incidences_all_ages, fill = cancer_site)) +
  geom_col() +
  facet_wrap(~cancer_site)
  
  
```

## Question 3 - How does this break down across demographics? (gender)

```{r}
by_health_board %>%
  select(1:7) %>%
  filter(hb == "S08000016", cancer_site != "All cancer types",
         cancer_site == "Breast" | 
         cancer_site == "Trachea, bronchus and lung" |
          cancer_site == "Non-melanoma skin cancer" |
          cancer_site == "Colorectal cancer" | 
          cancer_site == "Basal cell carcinoma of the skin",
         sex == "Female" | sex == "Male"
         ) %>%
  ggplot(aes(x = year, y = incidences_all_ages, fill = sex)) +
  geom_col(position = "dodge")
```

# The question / hypothesis I'm asking is - is the difference between male and female diagnoses statistically significant? This is 194. 

```{r}
total_sum_by_sex <- by_health_board %>%
  select(1:7) %>%
  filter(hb == "S08000016", cancer_site != "All cancer types",
         sex == "Female" | sex == "Male")

by_health_board %>%
  select(1:7) %>%
  filter(hb == "S08000016", cancer_site != "All cancer types",
         sex == "Female" | sex == "Male") %>%
  group_by(sex) %>%
  summarise(total_sum = sum(incidences_all_ages))

# null hypothesis - π1−π2=0 / total_sum_female-total_sum_male = 0
# alternative hypothesis - total_sum_female-total_sum_male != 0
# significance level - 0.05

```

## Question 4 - Statistically - given that one of the 5 most prevalent types is related to biological sex, is there a statistical correlation between sex and cancer diagnosis?

```{r}
# calculating null distribution
null_dist_sex <- total_sum_by_sex %>%
  specify(incidences_all_ages ~ sex) %>%
  hypothesise(null = "independence") %>%
  generate(reps = 5000, type = "permute") %>%
  calculate(stat = "diff in means",
            order = c("Female", "Male"))

obs_stat_sex <- by_health_board %>%
  select(1:7) %>%
  filter(hb == "S08000016", cancer_site != "All cancer types",
         sex == "Female" | sex == "Male") %>%
  specify(incidences_all_ages ~ sex) %>%
  calculate(stat = "diff in means",
            order = c("Female", "Male"))
  
null_dist_sex %>%
  visualise() +
  shade_pvalue(obs_stat = obs_stat_sex,
                direction = "left")

p_value_sex <- null_dist_sex %>%
  get_p_value(obs_stat = obs_stat_sex,
              direction = "left")
p_value_sex


# the p value is 0.0928. Therefore, there is insufficient evidence for rejecting the null hypothesis. 

# However - this is looking at all years, and all types. A key recommendation would be to investigate further into specific years, and targeted types.
# Looking back on the initial graph that sparked this question, it would also bear investigating to see how proportions have changed from 1995 to 2019. 

```
In summary:

- The 5 most prevalent types are:
Breast
Trachea, bronchus and lung
Non-melanoma skin cancer
Colorectal cancer
Basal cell carcinoma of the skin

- Since 1995 (when data collection began), for 3 of these types, these have remained pretty steady.
However, Basal Cell and Non-melanoma have increased in diagnosis numbers. 

- Across sex, this.... ?

- As breast cancer is one of the 5 most diagnosed, this begs the question of whether
biological sex is a statistically significant difference. This was examined; a 
p-value of 0.0928 was found, meaning that there was insufficient evidence for 
rejecting the null hypothesis. However - the sample was using all years, and all diagnosis types.

- As for recommendations, it would 

